---
занятие:
  - "[[Как работать с периферией микроконтроллера]]"
дата: 2026-02-17
tags:
  - занятие3
  - теория
---

Мы уже очень много поговорили о периферии, но пока так и не понятно, как ей управлять. Сначала давайте разберёмся, что такое регистры и как в них записываются значения. После чего посмотрим на карту регистров, которая окончательно закроет вопрос управления периферией.

## Регистр

Начнём с определения:

>[!NOTE] Определение
>**Регистр** — аппаратная ячейка памяти фиксированной разрядности, способная хранить одно двоичное слово и допускающая операции записи и чтения.

В определении фигурирует **двоичное слово**. Так называют последовательность битов фиксированной длины, которую процессор или периферия обрабатывают как единое целое: один номер, одна команда, одна порция данных. Разрядность слова задаётся архитектурой: в RP2040 слово обычно 32 бита (4 байта) — такое слово помещается в один регистр и обрабатывается одной машинной командой. Название «слово» (*word*) пришло из аналогии с естественным языком: как слово в тексте — минимальная осмысленная единица, так и в машине слово — минимальная единица данных, с которой процессор работает за один такт (сложение, сдвиг, запись в память). Отсюда же термины «машинное слово» и «длина слова».

Соответственно все регистры в нашем микроконтроллере 32-битные. Регистры служат для хранения информации во время исполнения программы. Регистры есть почти у каждого аппаратного модуля внутри микроконтроллера.

Самые важные регистры — это регистры процессора. В RP2040 стоят два ядра **ARM Cortex-M0+**; у каждого ядра свой набор регистров. Если вам интересно, можете прочитать список всех регистров процессора в статье [[Регистры ядра Cortex-M0+ (RP2040)]].

И, конечно же, регистры есть у периферии. В этих регистрах хранятся все настройки модулей периферии, через них мы можем забирать данные, генерируемые периферией. Каждый регистр также 32-битный и у каждого из регистров есть свой адрес в общем адресном пространстве микроконтроллера. Если к своим регистрам у процессора есть прямой доступ, то к регистрам периферии доступ осуществляется посредством транзакций на шине памяти. Разберёмся, что такое шина, что такое шина памяти и как по ней проходит одна такая транзакция.

## Транзакции на шине памяти

### Что такое шина

В микроконтроллере процессорное ядро, память и периферийные модули должны обмениваться данными. Проводить отдельную цепочку проводов от ядра к каждому блоку нерационально: выводов не хватит, схема станет невероятно сложной. Вместо этого используют общий путь, к которому подключены все участники.

>[!NOTE] Определение
>**Шина** (*bus*) — общий канал связи, к которому подключено несколько устройств и по которому передаётся информация по правилам одного протокола. В каждый момент времени обмен обычно ведут два участника: один передаёт, другой принимает (или один запрашивает, другой отвечает).

По аналогии с городским автобусом: один маршрут (шина), много остановок (устройства). Чтобы передать «пассажира» (данные) от одной остановки к другой, все должны соблюдать расписание и правила дорожного движения (протокол). В микроконтроллере по шине передаются адреса, данные и управляющие сигналы (например, чтение или запись).

### Что такое шина памяти

Внутри RP2040 процессор и периферия обращаются к памяти и к регистрам периферии единым способом — чтением и записью по адресу. Адресное пространство одно: по одним адресам расположена RAM, по другим — регистры GPIO, UART, таймеров и т.д. Тот канал, по которому передаются именно такие запросы (адрес + операция чтения/записи + данные), и есть шина памяти.

>[!NOTE] Определение
>**Шина памяти** (*memory bus*) — шина, по которой выполняются операции чтения и записи по адресу. По ней процессор (или модуль DMA) передаёт адрес и тип операции; устройство, «привязанное» к этому адресу (блок памяти или периферийный модуль), возвращает данные при чтении или принимает их при записи.

Таким образом, обращение к регистру периферии для процессора выглядит так же, как обращение к ячейке RAM: та же шина, та же операция «прочитать» или «записать» по адресу. Различие только в том, какой блок микросхемы ответит на этот адрес — массив памяти или регистры периферии. Такой способ доступа к периферии называют **memory-mapped I/O**.

>[!NOTE] Определение
>**Memory-mapped I/O** (*ввод-вывод, отображённый в память*) — способ организации доступа к периферии, при котором регистры периферийных устройств размещены в общем адресном пространстве процессора наряду с оперативной и другой памятью. Обращение к периферии выполняется теми же командами чтения и записи по адресу, что и обращение к памяти; выбор «память или периферия» определяется только адресом и выполняется аппаратно.

Для программиста это означает: чтобы включить светодиод или прочитать байт из UART, достаточно записать или прочитать значение по нужному адресу — никаких отдельных инструкций «ввод/вывод» не требуется.

### Как происходит транзакция

Одна операция чтения или записи по адресу на шине памяти называется **транзакцией**. Инициатор транзакции (процессор или DMA) называется **ведущим** (*master*); устройство, которое по адресу отвечает или принимает данные — **ведомым** (*slave*): это может быть блок RAM, Flash или периферийный модуль.

Упрощённо последовательность такая:

1. **Мастер выставляет на шину адрес** — число, указывающее ячейку памяти или регистр (в RP2040 адрес 32-битный).
2. **Мастер указывает тип операции**: чтение или запись (управляющий сигнал на шине).
3. **При записи**: мастер выставляет на шину данных значение (32 бита), которое нужно записать по этому адресу. Периферия или память, «узнав» свой адрес, забирает данные и обновляет регистр или ячейку.
4. **При чтении**: устройство, которому принадлежит адрес (память или периферия), выставляет на шину данных своё значение; мастер считывает его и сохраняет в регистр процессора или в буфер DMA.

В один момент времени на шине выполняется одна транзакция. Кто именно ответит по адресу, определяется аппаратной дешифрацией адреса: каждый блок «знает» свой диапазон адресов и реагирует только на него. Так одна шина памяти связывает ядро со всей RAM и со всеми регистрами периферии — этого достаточно, чтобы управлять периферией из программы, записывая и читая по нужным адресам.

Ниже представлена схема системной шины RP2040 (Bus Fabric) [[RP2040 Datasheet.pdf#page=15|ссылка на даташит]].

![[Pasted image 20260217171827.png]]

На схеме модули обозначены тремя цветами:
- фиолетовые — источники или приёмники данных;
- желтые — служебные модули системной шины;
- синие — память;

Сверху на шине три мастер: ядро 0, ядро 1 и DMA (фиолетовые). Только они могут инициировать транзакции на системной шине.

Ниже идут коммутаторы шины (жёлтые), они по сути действуют как роутеры в сети: по адресу определяют, в какое аппаратное устройство нужно отправить транзакцию. В микроконтроллере два типа системной шины: AHB (**Advanced High-performance Bus**) для очень быстрых транзакций — к ней подключены вся память и контроллер USB; и APB (**Advanced Peripheral Bus**) для более медленных транзакций и работы с периферией. Так как APB и AHB — это два разных протокола, необходимо преобразование одного в другой (APB Bridge). 

В середине (синие) блоки памяти. Очевидно, что все мастера должны иметь доступ к памяти и желательно наиболее быстрый, так как в ней хранятся переменные и данные необходимые для выполнения программы.

Правее памяти, три слейва требующих высокой скорости обмена. Это модуль XIP, через который мы получаем доступ к прошивке во флэш-памяти. Это USB при помощи, которого мы эту прошивку грузим во флэш. И модули PIO (о них в другой раз).

В самом низу медленные периферийные модули, которым не нужна высокая скорость обмена данными. По сути, в них мы будем записывать настройки и читать статусы. Больших наборов данных эти модули не генерируют.

## Карта регистров

Каждый модуль периферии имеет карту регистров. В контексте **memory-mapped I/O** это понятие формулируется так:

>[!NOTE] Определение
>**Карта регистров** (*register map*) — описание набора регистров периферийного модуля, отображённых в адресное пространство памяти: базовый адрес модуля, смещение каждого регистра относительно базового, имя, назначение (чтение/запись/только чтение) и смысл битовых полей. Карта регистров задаёт, по какому адресу и каким значением управлять модулем и откуда читать его состояние или данные.

Карту регистров публикует производитель микроконтроллера в документации (Datasheet, Reference Manual). По ней программист или драйвер определяет, какой адрес использовать для записи, например, уровня на выводе GPIO или для чтения очередного байта из UART. Без карты регистров работа с периферией «по адресам» была бы невозможна.

Подробно всю карту адресов можно [[RP2040 Datasheet.pdf#page=25|посмотреть в даташите]]

| **[[Периферия микроконтроллера\|Предыдущий раздел]]** | [[Как работать с периферией микроконтроллера\|К занятию]] | **[[Разбираемся с периферией на примере АЦП\|Следующий раздел]]** |
| ------------------------------------------ | --------------------------------------------------------- | -------------------------------------------- |
