---
тема: Как работать с внешней периферией
автор: Егор Анатольевич Денисов
дата: 2026-02-25
---

# Результат

- [ ] cоздана копия проекта `02-control` под названием `04-bme`
- [ ] создана папка `libs` с библиотекой `protocol`
- [ ] написан `CMakeLists.txt` библиотеки `protocol`
- [ ] библиотека `protocol` добавлена в проект `04-bme`
- [ ] проект собран, запущен, отвечает на команду `version`

# Инструкция

1. Создать копию проекта `02-control` под названием `04-bme`

2. Создать в корне репозитория `mcu` папку с названием `libs` для хранения библиотек

3. В папке `libs` создать библиотеку `protocol` со следующей структурой файлов. Файлы `protocol-task.h` и `protocol-task.с` скопировать из проекта `04-bme`. В самом проекте эти файлы удалить. Файл библиотеки `CMakeLists.txt` создать пустой.

```
mcu
|-- libs
|   |-- protocol
|   |   |-- include
|   |   |   `-- protocol-task.h
|   |   |-- src
|   |   |   `-- protocol-task.cpp
|   |   `-- CMakeLists.txt
|-- 02-control
|-- 03-adc
`-- 04-bme
    |-- led-task
    |-- stdio-task
    |-- main.c
	|-- CMakeLists.txt
	|-- memmap_rp2040.ld
	`-- pico_sdk_import.cmake
```

4. В `CMakeLists.txt` библиотеки `protocol` создать  базовый скрипт сборки библиотеки:

``` cmake
cmake_minimum_required(VERSION 3.15)

project(protocol)

add_library(${PROJECT_NAME} STATIC
	"src/protocol-task.c"
)

target_include_directories(${PROJECT_NAME} PUBLIC
	"include"
)
```

5. В `CMakeLists.txt` проекта `04-bme` убрать добавление `protocol` как исходников. Удалить строчку:

``` cmake
${CMAKE_CURRENT_SOURCE_DIR}/protocol-task/protocol-task.c
```

6. В `CMakeLists.txt` проекта `04-bme` добавить загрузкку и испонение `CMakeLists.txt` библиотеки `protocol`:

``` cmake
add_subdirectory("../libs/protocol" "${PROJECT_BINARY_DIR}/protocol")
```

7. Поключить в `target_link_libraries` библиотеку `protocol`

8.  в `main.c` изменить путь к `protocol-task.h` на путь без префиксов

> [!INFO] Справка
> Строчка `target_include_directories(${PROJECT_NAME} PUBLIC "include")` в `CMakeLists.txt` библиотеки `protocol` добавляет `include`  в пути для поиска заголовочных файлов. За счет этого не надо писать полный абсолютный или относительный путь.

9. скомпилировать прошивку, загрузить в RP2040, проверить работоспособность. На вызов команды `version`, RP2040 должен возвращать в COM-порт имя устройства и версию прошивки.
