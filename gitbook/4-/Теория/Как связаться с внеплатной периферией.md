---
занятие:
  - "[[Как работать с внешней периферией]]"
дата: 2026-02-25
tags:
  - занятие4
  - теория
---
Когда датчик находится за пределами печатной платы, перед нами встаёт задача передачи информации на расстояния больше 10–15 см (примерные размеры платы). Решение этой задачи зависит от технического задания: какое расстояние, какие условия среды, сколько устройств и т.д. Мы будем говорить только о проводных соединениях.

Важно понимать, что беспроводные соединения тоже решают задачу получения данных с удалённых устройств. Но чаще всего это уже не просто датчик, а полноценная встраиваемая система со своим микроконтроллером, памятью и периферией. Возможность передавать информацию по беспроводному каналу — лишь одна из её функций. Обмен данными между двумя такими устройствами выходит за рамки занятия.

## Разъёмное соединение

В проводном соединении есть провод, а значит, есть проводник, который нужно куда-то подключить. Можно ли припаять провод прямо к ножкам микроконтроллера? Вы можете попробовать, но поскольку ножки микроконтроллера достаточно маленькие и площадь соприкосновения небольшая, механически такое соединение будет ненадёжным и оторвётся в самый неподходящий момент.

>[!NOTE] Из практики
>Иногда для целей отладки можно припаять тонкие проводки к ножкам микроконтроллера и посмотреть сигналы на осциллографе, но это редкое исключение.

Можно припаять провод к дорожкам платы — соединение будет тем крепче, чем шире дорожка и толще провод. В бытовых устройствах, где плата закрыта корпусом и неподвижна, так иногда делают. Но в мелкой электронике размеры контактов не дают надёжного механического соединения. А даже если получится припаять надёжно — что, если датчик нужно отключить? Разбирать всё устройство? Искать паяльник?

Так мы приходим к тому, что чаще всего необходимо **разъёмное соединение**.

>[!NOTE] Определение
>**Разъёмное соединение** (*англ. connector*) — механическое соединение электрических контактов, которое позволяет надёжно удерживать соединение и при этом имеет механизм для его разъединения без инструментов.

Стандарты разъёмных соединений обычно определяют, какой сигнал передаёт каждый проводник. Вам никто не мешает подать на контакты USB 220 В, но делать этого не стоит — лучше следовать рекомендациям, описанным в стандарте.

Примеры разъёмов, которые вы можете встретить во встраиваемых системах:
- **Штыревые разъёмы** (*pin headers*) — ряды штырьков, как на Raspberry Pi Pico
- **Клеммники** (*terminal blocks*) — винтовые зажимы для проводов, удобны для силовых цепей
- **JST, Molex** — компактные разъёмы для подключения батарей, вентиляторов, датчиков


## Можно ли использовать I2C и SPI вне платы?

Да, но с ограничениями. SPI и I2C были разработаны для связи микросхем на одной печатной плате, а не для передачи данных по кабелям.

Основные проблемы при увеличении длины линии:
- **Ёмкость кабеля** — длинный кабель накапливает заряд и «сглаживает» фронты сигналов
- **Помехи** — длинный кабель работает как антенна и собирает наводки
- **Задержка сигнала** — на больших расстояниях сигнал приходит с задержкой, что нарушает синхронизацию

На практике I2C надёжно работает на расстояниях до **1 метра**, SPI — до **10–30 см** при высоких скоростях. Для бо́льших расстояний лучше выбрать интерфейс, изначально рассчитанный на длинные линии.

>[!NOTE] Из практики
>На Raspberry Pi 4 вы работали с SPI и I2C на коротких расстояниях — датчики подключались прямо к GPIO-разъёму платы. Поэтому вы не сталкивались с проблемами длинных линий. Но в промышленных системах датчики могут находиться в метрах или десятках метров от контроллера — и тут нужны другие интерфейсы.

## Проводные интерфейсы для длинных линий

Когда нужно передать данные на десятки или сотни метров, SPI и I2C не подходят. Для таких задач существуют специальные интерфейсы, использующие **дифференциальную передачу сигнала**.

>[!NOTE] Определение
>**Дифференциальная передача** (*англ. differential signaling*) — способ передачи, при котором сигнал передаётся по двум проводам как разность напряжений между ними. Помехи воздействуют на оба провода одинаково и взаимно компенсируются при вычитании. Это обеспечивает высокую помехоустойчивость.

### RS-485

**RS-485** (стандарт TIA/EIA-485) — один из самых распространённых интерфейсов для промышленной автоматизации. Он использует дифференциальную передачу и позволяет:
- Передавать данные на расстояния до **1200 метров**
- Подключать до **32 устройств** на одну шину
- Работать в условиях сильных электромагнитных помех

Скорость передачи зависит от длины линии: на коротких расстояниях возможны скорости до 10 Мбит/с, на максимальной длине — около 100 кбит/с.

RS-485 определяет только физический уровень — электрические характеристики сигналов. Протокол обмена данными (какие байты передавать и что они означают) выбирает разработчик. Часто поверх RS-485 используют протокол Modbus RTU.

### CAN

**CAN** (*Controller Area Network*) — интерфейс, разработанный компанией Bosch в 1980-х годах для автомобильной промышленности. Сегодня он используется в транспорте, промышленном оборудовании, медицинской технике.

Особенности CAN:
- **Дифференциальная передача** с высокой помехоустойчивостью
- **Нет ведущего устройства** — все узлы равноправны и могут начать передачу в любой момент
- **Арбитраж на уровне битов** — если два узла начинают передачу одновременно, побеждает сообщение с меньшим идентификатором
- **Обнаружение ошибок** — встроенные механизмы контроля целостности данных
- **Максимальная длина** — до 40 м при скорости 1 Мбит/с, до 1 км при 50 кбит/с (по стандарту ISO 11898)

В отличие от SPI и I2C, в CAN нет ведущего и ведомых. Любой узел может отправить сообщение, когда шина свободна. Если два узла начинают передачу одновременно, срабатывает **арбитраж**: каждый узел передаёт биты идентификатора своего сообщения и одновременно слушает шину. Если узел передал «1», а на шине видит «0» — значит, другой узел передаёт более приоритетное сообщение, и первый узел отступает. Сообщение с меньшим идентификатором (больше нулей в начале) имеет высший приоритет и передаётся без прерывания.

В отличие от RS-485, CAN определяет не только физический уровень, но и формат сообщений. Каждое сообщение имеет идентификатор, который определяет его приоритет и назначение.

| Характеристика | RS-485 | CAN |
|----------------|--------|-----|
| Максимальная длина | 1200 м | 40 м (1 Мбит/с) – 1 км (50 кбит/с) |
| Устройств на шине | до 32 | до 110 |
| Протокол | Только физический уровень | Физический + канальный уровень |
| Типичное применение | Промышленная автоматизация, «умный дом» | Автомобили, промышленное оборудование |

### Как подключить RS-485 или CAN к микроконтроллеру?

В RP2040 нет аппаратной поддержки RS-485 или CAN. Но это не значит, что их нельзя использовать — просто потребуется внешняя микросхема.

Дело в том, что RS-485 и CAN работают с дифференциальными сигналами, а GPIO микроконтроллера выдаёт обычные логические уровни (0 и 3,3 В). Для преобразования между ними используются **трансиверы**.

>[!NOTE] Определение
>**Трансивер** (*англ. transceiver* — от *transmitter* + *receiver*) — микросхема, объединяющая передатчик и приёмник для преобразования сигналов между разными физическими интерфейсами.


![[tranciever.png]]

Для RS-485 микроконтроллер использует обычный UART (TX/RX), а трансивер (например, MAX485 или SP485) преобразует сигналы в дифференциальную пару A/B. С точки зрения программы вы просто отправляете и принимаете байты через UART — трансивер делает всё остальное.

Для CAN ситуация немного сложнее. CAN — это не только физический уровень, но и протокол с форматом сообщений, приоритетами и контролем ошибок. Поэтому используют два варианта:
- **Внешний CAN-контроллер** (например, MCP2515) — подключается по SPI и берёт на себя всю работу с протоколом CAN
- **Микроконтроллер со встроенным CAN** — многие микроконтроллеры (STM32, ESP32) имеют аппаратный CAN-модуль, и тогда нужен только трансивер (например, MCP2551)

>[!NOTE] Из практики
>При выборе микроконтроллера для проекта важно заранее понимать, какие интерфейсы вам понадобятся. Если проект требует CAN — возможно, стоит выбрать микроконтроллер со встроенной поддержкой. Если требуется только RS-485 — подойдёт практически любой микроконтроллер с UART и внешний трансивер за несколько рублей.

## Итог

Мы разобрались, как подключить внеплатную периферию к микроконтроллеру. Для коротких расстояний (до метра) можно использовать знакомые I2C и SPI с разъёмным соединением. Для длинных линий (десятки и сотни метров) существуют специальные интерфейсы — RS-485 и CAN, которые используют дифференциальную передачу и устойчивы к помехам.

Теперь мы знаем, какие интерфейсы существуют и когда их применять. Но как использовать их в коде? Для внутренней периферии (GPIO, SPI, I2C) есть готовые функции в Pico SDK. А вот для внешней периферии — конкретного датчика или дисплея — код часто приходится писать самим. Именно об этом поговорим в следующем разделе.

| **[[Как связаться с внешней периферией\|Предыдущий раздел]]** | [[Как работать с внешней периферией\|К занятию]] | **[[Драйвер внешней периферии\|Следующий раздел]]** |
| ------------------------------------------------------------- | ------------------------------------------------ | --------------------------------------------------- |
