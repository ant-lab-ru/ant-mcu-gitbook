
Рассмотрим три интерфейса, которые чаще всего используются для связи микроконтроллера с периферией на одной плате. Каждый из них имеет свои особенности, и выбор зависит от требований к скорости, количеству устройств и доступных пинов.

### SPI

**SPI** (*Serial Peripheral Interface*) — синхронный интерфейс, разработанный компанией Motorola в 1980-х годах. Это один из самых быстрых и простых интерфейсов для связи между микросхемами.

**Основные характеристики:**
- Последовательный
- Синхронный
- Полный дуплекс

SPI работает по принципу «ведущий-ведомый» (*master-slave*). Ведущее устройство (микроконтроллер) генерирует тактовый сигнал и управляет обменом. Для этого используются четыре линии:
- **MOSI** (*Master Out Slave In*) — данные от ведущего к ведомому
- **MISO** (*Master In Slave Out*) — данные от ведомого к ведущему
- **SCK** (*Serial Clock*) — тактовый сигнал, генерируемый ведущим
- **CS** (*Chip Select*, также называют SS — *Slave Select*) — выбор ведомого устройства

![[SPI_single_slave.svg.png]]

Набор линий зависит от задачи. Например, если вам нужно только передавать данные в ЦАП, достаточно использовать **MOSI** и **SCK**, тогда интерфейс работает в симплексном режиме. ЦАП будет принимать данные по тактовому сигналу и преобразовывать их в напряжение. Но если устройство может отвечать, необходимо использовать и **MISO**, а иногда и **CS**.

**CS** особенно важен, если вы хотите подключить несколько устройств к одному интерфейсу SPI. В таком случае линии MOSI, MISO и SCK подключаются параллельно ко всем устройствам, а каждый CS подключается к отдельному ведомому.

Когда CS устройства неактивен, оно должно игнорировать данные на MOSI и, что важнее, перевести свою линию MISO в **высокоимпедансное состояние** (*Hi-Z*). Это позволяет другим устройствам использовать общую линию MISO без конфликтов.

>[!NOTE] Определение
>**Высокоимпедансное состояние** (*англ. Hi-Z, high impedance*) — состояние пина микросхемы, при котором он электрически «отключён» от линии. Выход не выдаёт ни логический 0, ни логическую 1 — он как бы «не существует» для остальных устройств на линии. Это позволяет нескольким устройствам делить одну линию данных, не мешая друг другу.

![[SPI_three_slaves.svg.png]]

Скорость SPI может достигать десятков мегагерц — в RP2040 до 62,5 МГц. Это делает SPI идеальным выбором для устройств, требующих высокой пропускной способности: флеш-память, дисплеи, быстрые АЦП и ЦАП.

Кроме того, инженеры захотели увеличить пропускную способность SPI и добавили четыре линии данных вместо двух. Этот вариант называется **QuadSPI (QSPI)** и особенно популярен для подключения микросхем памяти.

>[!NOTE] Из практики
>Флеш-память на плате Raspberry Pi Pico подключена к микроконтроллеру именно по SPI (точнее, по его варианту QSPI с четырьмя линиями данных). Это позволяет быстро читать код программы прямо из внешней памяти.

### I2C

**I2C** (*Inter-Integrated Circuit*, произносится «ай-ту-си» или «ай-сквэрд-си») — синхронный последовательный интерфейс, разработанный компанией Philips в 1982 году. Главное преимущество I2C — для подключения множества устройств достаточно всего двух проводов.

**Основные характеристики:**
- Последовательный
- Синхронный
- Полу-дуплекс

I2C использует две линии:
- **SDA** (*Serial Data*) — линия данных (полу-дуплекс)
- **SCL** (*Serial Clock*) — тактовый сигнал

![[I2C.png]]

В отличие от SPI, вместо отдельных линий выбора каждое устройство на шине I2C имеет уникальный **адрес** — 7-битное число. Когда ведущий хочет обратиться к устройству, он сначала отправляет его адрес на шину. Устройство с таким адресом откликается, остальные игнорируют обмен.

Но есть у такого решения и минус: адреса устройств фиксированы производителем. Если вам нужно подключить два одинаковых датчика, придётся проверить, можно ли изменить адрес (некоторые датчики позволяют это сделать через специальный пин).

Скорость I2C ниже, чем у SPI. Стандартный режим — 100 кГц, быстрый режим — 400 кГц, есть режимы до 3,4 МГц, но они редко используются. Для большинства датчиков этого достаточно.

I2C применяется для подключения датчиков температуры, влажности, давления, акселерометров, часов реального времени (RTC), микросхем памяти EEPROM.

>[!NOTE] Из практики
>Типичная ситуация: вы покупаете датчик температуры, а в документации указан I2C-адрес 0x48. Если на этой же шине уже есть устройство с таким адресом, возникнет конфликт. Поэтому перед проектированием платы полезно составить список всех I2C-адресов.

### UART

**UART** (*Universal Asynchronous Receiver-Transmitter*) — асинхронный интерфейс, один из старейших способов последовательной связи. В отличие от SPI и I2C, здесь нет тактового сигнала — устройства должны заранее договориться о скорости передачи.

**Основные характеристики:**
- Последовательный
- Асинхронный
- Полный-дуплекс

UART использует две линии:
- **TX** (*Transmit*) — передача данных
- **RX** (*Receive*) — приём данных

![[UART.png]]

Обратите внимание: TX одного устройства подключается к RX другого, и наоборот. Это логично — передатчик одного должен быть соединён с приёмником другого.

UART — это связь точка-точка. На одну пару линий TX/RX можно подключить только два устройства. Если нужно больше — потребуются дополнительные UART-модули или другой интерфейс.

Стандартные скорости UART: 9600, 19200, 38400, 57600, 115200 бод. Скорость 115200 бод означает примерно 11 520 байт в секунду (с учётом стартового и стопового битов). Это значительно медленнее SPI, но для многих задач достаточно.

UART часто используется для:
- Отладочной консоли (Serial Monitor в Arduino IDE, `minicom` в Linux)
- Подключения GPS-модулей
- Связи между двумя микроконтроллерами
- Модемов и радиомодулей

>[!NOTE] Из практики
>Когда вы подключаете Raspberry Pi Pico к компьютеру через USB и открываете Serial Monitor — это не совсем UART. USB эмулирует последовательный порт (CDC — Communications Device Class). Но если вы подключите GPS-модуль к пинам GP0/GP1 — это будет настоящий аппаратный UART.

### Сравнение интерфейсов

| Характеристика            | SPI                               | I2C                         | UART                              |
| ------------------------- | --------------------------------- | --------------------------- | --------------------------------- |
| **Тип**                   | Последовательный                  | Последовательный            | Последовательный                  |
| **Синхронизация**         | Синхронный                        | Синхронный                  | Асинхронный                       |
| **Количество проводов**   | 4 + CS на каждое устройство       | 2                           | 2                                 |
| **Максимальная скорость** | До 62,5 МГц (RP2040)              | До 400 кГц (типично)        | До 115200 бод (типично)           |
| **Топология**             | Один ведущий, много ведомых       | Один ведущий, много ведомых | Точка-точка                       |
| **Адресация**             | Отдельная линия CS                | 7-битный адрес              | Нет                               |
| **Дуплекс**               | Полный                            | Полудуплекс                 | Полный                            |
| **Типичное применение**   | Дисплеи, флеш-память, быстрые АЦП | Датчики, EEPROM, RTC        | Отладка, GPS, связь между платами |

>[!NOTE] Из практики
>Как выбрать интерфейс? Если нужна высокая скорость — SPI. Если нужно подключить много медленных датчиков с минимумом проводов — I2C. Если нужна простая связь между двумя устройствами без жёстких требований к скорости — UART.


| **[[Как связаться с внешней периферией\|Предыдущий раздел]]** | [[Как работать с внешней периферией\|К занятию]] | **[[Как связаться с внеплатной периферией\|Следующий раздел]]** |
| ------------------------------------------------------------- | ------------------------------------------------ | --------------------------------------------------------------- |
