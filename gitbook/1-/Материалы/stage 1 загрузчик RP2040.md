---
тема: Как начать работать с микроконтроллерами
автор: Егор Анатольевич Денисов
дата: 2026-01-22
---

Микроконтроллер RP2040 имеет нетиповую и достаточно сложную систему загрузки. В рамках данного курса мы не будем изучать ее подробно, однако один раз опишем как она устроена в качестве дополнительной информации.

Многие процессорные системы запускаются в несколько этапов. В компьютере, например, сначала запускается bios, затем загрузчик операционной системы, затем сама операционная система. Идея этапности простая: простая программа запускает более сложную. Подход имеет массу преимуществ, мы можем: обновлять ОС, выбирать какую системы запустим, конфигурировать оборудование компьютера, искать неисправности и т.д.

При разработке проектов под почти все микроконтроллеры, например STM32, можно запускать только одну прошивку, нет необходимости делать поэтапную загрузку. Процессор сам начнет исполнять команды из встроенной памяти. Хотя, во многих реальных проектах разработчики специально добавляют в архитектуру загрузчик, чтобы иметь возможность обновить основную прошивку.

В RP2040 ситуация отличается от основной массы микроконтроллеров. В нем используются целых два загрузчика и отказаться от них использования нельзя. Они называются stage 1 загрузчик и stage 2 загрузчик. stage 1 находится в ROM памяти RP2040. Его невозможно изменить или удалить, он запускается всегда. В зависимости от состояния вывода `QSPI_SS` (именно его состояние мы меняем кнопкой BOOTSEL), stage 1 либо переходит в режим BOOTSEL, тогда плата отображается в компьютере как флешка и мы можем обновить прошивку, либо выгружает stage 2 загрузчик из FLASH памяти и передает управление ему.

Stage 2 загрузчик является частью нашей прошивки, которую мы собирали. Он подкладывается на этапе линковки, это можно посмотреть в скрипте компоновщика. Stage 2 лежит в самом начале и занимает ровно 256 байт (да, очень маленький, на то он и загрузчик). Здесь надо упомянуть, что RP2040 имеет еще одну особенность: у него нет встроенной постоянной памяти, кроме том, где лежит stage 1. Это вполне обычно для микроконтроллеров. Внешняя память уменьшает цену микроконтроллера и позволяет получить огромный объем памяти за счет внешнего чипа FLASH. У дешевых плат pico памяти 4 МБ (бывает и 16 МБ), а у самых дорогих STM32 всего 1 МБ. Внешняя FLASH память подключена к микроконтроллеру по интерфейсу QSPI. Для работы по QSPI на максимальной скорости его нужно настроить под конкретный чип QSPI FLASH памяти. RP2040 может работать с любой подобной памятью, поэтому настройка предоставляется пользователю. Именно для настройки QSPI FLASH памяти и шины нужен stage 2 загрузчик. На самом деле, популярный производителей QSPI FLASH мало, и для каждого из них в pico-sdk уже есть написанные stage 2 загрузчики, которые автоматический подгружаются в проект. Т.к. мы в CMakeLists.txt указали, что используем плату pico, из SDK автоматически подтянулся stage 2 загрузчик именно для того чипа памяти, который впаян на pi-pico. После работы stage 2 заргузчика запускается уже основная прошивка и далее все не отличается от других микроконтроллеров.
