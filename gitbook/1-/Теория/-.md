---
занятие:
  - "[[Как начать работать с микроконтроллерами]]"
дата: 2026-01-25
tags:
  - занятие1
  - теория
---
## Что снаружи?

Микроконтроллер — это интегральная схема, чаще всего облачённая в корпус для защиты самого кристалла от физических повреждений, бывают специальные версии микроконтроллеров без корпусов, но это большая редкость.

По бокам микроконтроллера или снизу выведены множество электрических контактов, которые называются пинами или "ножками" микроконтроллера. Каждый из них имеет собственный функционал и назначение.

![[RP2040 Package.png]]
## Что внутри?

Мы уже видели структурную схему устройства микроконтроллера, теперь давайте еще глубже погрузимся в его внутреннее устройство. Проще всего это будет сделать на примере микроконтроллера RP2040 и платы Raspberry Pi Pico, с которыми мы будем работать в этом курсе.

Ниже на картинке представлена схема устройства RP2040.
![[Структурная схема RP2040.png]]
На этой схеме пока много незнакомых вам слов, но наша цель, чтобы к концу курса эта схема была вам полностью понятна. Для начала найдём здесь уже знакомые нам модули.
### Процессорные ядра

Первым обсудим сердце микроконтроллера, а именно его процессорные ядра. В RP2040 два процессорных ядра, на картинке они нарисованы справа сверху под названиями **Proc0** и **Proc1**. В данном микроконтроллере это ядра **ARM Cortex M0+**. Как мы помним, тип ядра определяет набор доступных нам операций, это ядро достаточно простое, в нём всего 56 доступных инструкций. 

>[!INFO] Дополнительно
> Если вам интересно, какие инструкции есть у этого ядра, то полную таблицу с инструкциями можно посмотреть в файле: [[Набор инструкций Cortex-M0+]]
> 
> На первом этапе вам не нужно знать детали архитектуры процессора. Достаточно понимать, что ядро выполняет ваш код. В будущем, если вы столкнётесь с необъяснимыми проблемами, то просмотр машинного кода в виде ассемблерных инструкций может помочь понять вам, что идёт не так.

Еще одна важная характеристика ядра — это его разрядность, она определяет размер адресного пространства и ширину данных, с которыми может работать ядро. Ядро Cortex-M0+ является 32-битным.

### Системная шина

На схеме видно, что оба ядра подсоединены к устройству под названием Bus Fabric, это системна шина, через неё ядра получают доступ к инструкциям и данным. Единственный способ обмена информацией для процессора — это запись и чтение через системную шину памяти. Поэтому для процессора все устройства выглядят как значения по адресам памяти. Таким образом, все внутренности микроконтроллера существуют в едином адресном пространстве. Размер этого адресного пространства определяется размерностью шины и для 32-бит существует 2^32 байт = 4ГиБ (гибибайт, не путать с гигабайт) адресного пространства. Ниже представлена таблица описания всего адресного пространства микроконтроллера RP2040

Ниже представлена упрощенная схема разделов памяти, подробнее можете прочитать в отдельном файле [[Карта памяти RP2040]]

![[rp2040_memmap.jpg]]

>[!INFO] Дополнительно
>Для процессора весь мир — это память.

### Память микроконтроллера

В прошлых разделах мы с вами узнали, что еще одним важным компонентом вычислительного устройства является память. Тут нас ждёт первое столкновение с реальностью: в RP2040 нет энергонезависимой памяти. То есть программа не хранится внутри микроконтроллера, она хранится на внешней микросхеме памяти.

Давайте посмотрим, какая память есть в RP2040, на схеме она расположена под Bus Fabric. В части памяти (*Memory*) есть три типа устройств:
- Несколько SRAM
- ROM
- XIP

>[!NOTE] Определение
>SRAM (Static Random Access Memory) — статическая память произвольного доступа, позволяющая иметь быстрый доступ к произвольными элементам памяти, но являющаяся энергозависимой

В данной памяти хранятся все переменные, которые генерируются в процессе работы программы.

>[!NOTE] Определение
>ROM (Read-Only Memory) — энергонезависимая память доступная только для чтения, такая память используется для хранения неизменяемых данных

Зачем микроконтроллеру память, которую нельзя менять? В RP2040 в ней хранится алгоритм загрузки программы через USB, вспомогательные программы необходимые для загрузки основных программ называют **загрузчиками** (*англ. bootloader*). Это достаточно важная программа, поэтому очевидно, что алгоритм загрузки программы не должен изменяться со временем. Также иногда в ROM хранят серийный номер микросхемы и другую идентификационную информацию.

Наконец, **XIP** (*eXecution-In-Place, исполнение на месте*). Это модуль, который позволяет исполнять инструкции из внешней Flash-памяти и представляет для процессора эту внешнюю память так, как будто она является внутренней. В энергонезависимой памяти хранится ваша программа, все константы и строковые литералы.

### Периферия

>[!NOTE] Определение 
>**Периферия** — это аппаратные блоки внутри микроконтроллера, которые выполняют специализированные функции вывода-вывода и обработки данных.

Чтобы разобраться зачем нужна периферия, нужно разобраться с различием в терминах **"аппаратный"** и **"программный"**. 

Возьмём, например, функцию перемножения двух матриц. Мы можем написать алгоритм, который читает последовательно элементы матрицы из памяти и выполняет перемножение, но поскольку процессор способен исполнять только одну инструкцию за раз, то это займёт у него много времени и он будет неспособен выполнять другие инструкции. Это будет **программная** реализация. 

Если же в нашем микроконтроллере будет отдельный **аппаратный** (в смысле электронная схема, реализованная на кристалле микроконтроллера) блок, который подсоединен к системной шине и может сам читать данные из памяти и сохранять результат в эту память, то наш алгоритм должен просто передать этому блоку информацию о том, где лежат две матрицы в памяти и куда сложить результат, после этого аппаратный блок перемножения матриц будет сам выполнять все записи и чтения в память и мы не будем занимать время работы процессора, а значит он может исполнять другие инструкции.

В общем, периферийные устройства выполняют прикладные задачи и расширяют функционал микроконтроллера. Чаще всего набор периферии определяет сложность и цену микроконтроллера. Поскольку чем больше периферии есть у микроконтроллера, тем сложнее становится системная шина, тем больше становится его потребление и дороже производство. 

Давайте посмотрим какие периферийные модули есть у RP2040:

| Модуль                         | Описание                                                                                                                                                                      |
| ------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [[GPIO]]                       | Модуль чтения и записи состояния пинов общего назначения.                                                                                                                     |
| [[UART]]<br>[[SPI]]<br>[[I2C]] | Стандартные интерфейсы обмена данных между электронными компонентами. С SPI вы работали на парах общеинженерной подготовки, когда общались с АЦП.                             |
| [[PWM]]                        | ШИМ. Модуль реализует широтно-импульсную модуляцию.                                                                                                                           |
| [[ADC]]                        | АЦП: позволяет измерять напряжение на некоторых заранее заданных ножках микроконтроллера. У АЦП четыре канала, к одному каналу подключен температурный сенсор.                |
| [[Timer]]                      | Модуль, который позволяет отсчитывать временные интервалы и выполнять действия по их окончанию.                                                                               |
| [[RTC]]                        | Позволяет получать время в календарном формате.                                                                                                                               |
| [[Watchdog]]                   | Таймер обратного отсчёта, который перезапускает программу микроконтроллера, если досчитает до нуля. Важен для предотвращения зависаний микроконтроллера в бесконечных циклах. |
Таким образом, одной из задач программы микроконтроллера становится взаимодействие с этими модулями: их настройка, чтение данных, обработка событий и т.д.. Поэтому инженеру всегда важно знать, какая периферия присутствует в микроконтроллере и как она работает.

| **[[Применение микроконтроллеров\|Предыдущий раздел]]** | [[Как начать работать с микроконтроллерами\|К занятию]] | **[[Встроенное программное обеспечение\|Следующий раздел]]** |
| ------------------------------------------------------- | ------------------------------------------------------- | ----------------------------------------------------------------------- |
