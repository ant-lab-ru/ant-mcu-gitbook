
## 1. MEMORY — определение регионов памяти

```
MEMORY
{
    FLASH(rx)    : ORIGIN = 0x10000000, LENGTH = 2M      (из pico_flash_region.ld)
    RAM(rwx)     : ORIGIN = 0x20000000, LENGTH = 256K
    SCRATCH_X    : ORIGIN = 0x20040000, LENGTH = 4K      (стек ядра 1)
    SCRATCH_Y    : ORIGIN = 0x20041000, LENGTH = 4K      (стек ядра 0)
}
```

| Регион | Адрес | Размер | Назначение |
|--------|-------|--------|------------|
| FLASH | `0x10000000` | 2 МБ | Код и константы (XIP) |
| RAM | `0x20000000` | 256 КБ | Данные, BSS, Heap |
| SCRATCH_X | `0x20040000` | 4 КБ | Стек ядра 1 |
| SCRATCH_Y | `0x20041000` | 4 КБ | Стек ядра 0 |

---

## 2. ENTRY — точка входа

```
ENTRY(_entry_point)
```

---

## 3. SECTIONS — секции во Flash

| Секция | Содержимое | Особенности |
|--------|------------|-------------|
| `.boot2` | Загрузчик 2-й стадии | Ровно 256 байт, проверяется ASSERT |
| `.text` | Исполняемый код | `.vectors`, `.reset`, код `main()` и SDK |
| `.rodata` | Константы только для чтения | Строки, `const` переменные |
| `.binary_info` | Метаданные прошивки | Версия, описание для picotool |

---

## 4. SECTIONS — секции в RAM

| Секция | Содержимое | Особенности |
|--------|------------|-------------|
| `.ram_vector_table` | Копия таблицы векторов | NOLOAD — не занимает Flash |
| `.data` | Инициализированные переменные | `> RAM AT> FLASH` — копируется стартапом |
| `.bss` | Неинициализированные переменные | NOLOAD — обнуляется стартапом |
| `.heap` | Динамическая память | Растёт вверх от `__end__` |
| `.stack_dummy` | Стек | В SCRATCH_Y, растёт вниз |

---

## 5. Ключевые символы для стартап-кода

| Символ | Назначение |
|--------|------------|
| `__boot2_start__` / `__boot2_end__` | Границы загрузчика 2 |
| `__data_start__` / `__data_end__` | Границы `.data` в RAM |
| `__etext` | Адрес `.data` во Flash (откуда копировать) |
| `__bss_start__` / `__bss_end__` | Границы `.bss` (обнулить) |
| `__StackTop` | Вершина стека (`0x20042000`) |
| `__HeapLimit` | Конец heap (`0x20040000`) |

---

## 6. Ключевая конструкция `> RAM AT> FLASH`

```
.data : {
    ...
} > RAM AT> FLASH
```

- **VMA (Virtual Memory Address)** = RAM (`0x200000C0`) — где используется
- **LMA (Load Memory Address)** = Flash (`0x10001F74`) — где хранится
- Стартап-код копирует данные из LMA в VMA

---

## 7. Проверки (ASSERT)

```
ASSERT(__boot2_end__ - __boot2_start__ == 256, "boot2 must be 256 bytes")
ASSERT(__StackLimit >= __HeapLimit, "RAM overflowed")
```

---

## Визуальная схема связи секций

```
              FLASH                              RAM
         ┌─────────────┐                   ┌─────────────┐
         │   .boot2    │                   │.ram_vector_ │
         │  (256 байт) │                   │   table     │
         ├─────────────┤                   ├─────────────┤
         │   .text     │                   │   .data     │◄─── копируется
         │  (код)      │                   │             │     из Flash
         ├─────────────┤    ┌─────────────►├─────────────┤
         │  .rodata    │    │              │   .bss      │◄─── обнуляется
         ├─────────────┤    │              ├─────────────┤
         │.data (LMA)  │────┘              │   .heap ↓   │
         │ (копия)     │                   │     ...     │
         └─────────────┘                   │   .stack ↑  │
                                           └─────────────┘
                                              SCRATCH_Y
```
