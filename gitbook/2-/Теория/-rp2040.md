
>[!NOTE] Вопрос
>Постойте, а как мы попадаем в **main**?


Продолжаем расширять наше понимание кода. В прошлом разделе мы узнали, что main это примерно 0.1% нашего кода. Сейчас мы узнаем, что на самом деле это далеко не первые инструкции исполняемые кодом.

**Во-первых**, как мы помним, самым первым исполняется загрузчик, который хранится в [[ROM]] и вообще говоря при включении исполнение начинается с него. Его адрес 0x00000000. 

Его задача инициализировать минимальную периферию, проверить не нажата ли кнопка BOOTSEL. Если она нажата нужно инициализировать USB и настроить всё так, чтобы ваш файл `.uf2` с прошивкой попал во Flash. После этого загрузчик перезагрузит микроконтроллер. 

Если же BOOTSEL не нажата, то нужно по стандартному протоколу общения с Flash-памятью по SPI проверить, есть ли в ее начале прошивка. Так происходит из-за того, что у RP2040 внешняя энергонезависимая память (Flash). В микроконтроллерах со встроенной flash-памятью исполнение обычно начинается с нее. Кстати, размер этого загрузчика около 16Кб, и в нём несколько тысяч инструкций, а мы еще не дошли до `main()`

**Во-вторых**, начинается исполнение загрузчика второй стадии. Да, в прошивке два загрузчика. Этот загрузчик очень небольшой и расположен в первых 256 байтах ВПО. Он будет скопирован из Flash в [[SRAM]] загрузчиком первой стадии. После копирования первый загрузчик командует процессору продолжить исполнение инструкций из расположения кода загрузчика второй стадии. Загрузчик второй стадии уже всё знает о нашей прошивке и о том, на какой микросхеме памяти хранится наша прошивка, а значит может настроить подходящий режим работы с памятью, чтобы корректно работал [[XIP]] и процессор думал, что прошивка лежит рядом с ним в доступной ему области памяти. Загрузчик второго уровня весит максимум 256 байт и содержит в себе примерно 64 инструкции.

**В-третьих**, начинается выполнение **стартап-кода**. Если наличие двух предыдущих частей кода на самом деле обусловлены устройством конкретного микроконтроллера, то стартап-код будет присутствовать в ВПО для любого микроконтроллера. Обычно в него входит загрузка таблицы векторов, Reset Handler и начальная инициализация ядра, памяти и важной периферии (подробнее о них поговорим дальше). И, наконец, передача управления в `main()`. Наш стартап-код содержит примерно 110 инструкций.

Ниже схема загрузки RP2040

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ЦЕПОЧКА ЗАГРУЗКИ RP2040                              │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────┐
    │  1. ЗАГРУЗЧИК ПЕРВОЙ СТАДИИ (Boot ROM)                              │
    │     Адрес: 0x00000000 │ Размер: ~16 КБ │ ~несколько тысяч инструкций│
    ├─────────────────────────────────────────────────────────────────────┤
    │  • Инициализация минимальной периферии                              │
    │  • Проверка кнопки BOOTSEL                                          │
    │    ├─ Нажата → USB режим, ждём .uf2 файл                            │
    │    └─ Не нажата → проверка Flash по SPI                             │
    │  • Копирование boot2 из Flash в SRAM                                │
    │  • Передача управления загрузчику второй стадии                     │
    └─────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │  2. ЗАГРУЗЧИК ВТОРОЙ СТАДИИ (Boot2)                                 │
    │     Адрес: 0x10000000 │ Размер: 256 байт │ ~64 инструкции           │
    ├─────────────────────────────────────────────────────────────────────┤
    │  • Выполняется из SRAM (скопирован загрузчиком первой стадии)       │
    │  • Знает параметры конкретной микросхемы Flash                      │
    │  • Настраивает режим XIP (eXecute In Place)                         │
    │  • Передача управления стартап-коду                                 │
    └─────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │  3. СТАРТАП-КОД                                                     │
    │     Адрес: 0x10000100 │ ~110 инструкций                             │
    ├─────────────────────────────────────────────────────────────────────┤
    │  • Таблица векторов (адреса обработчиков прерываний)                │
    │  • Reset Handler (точка входа после сброса)                         │
    │  • Инициализация ядра, памяти и периферии                           │
    │  • Копирование .data из Flash в RAM                                 │
    │  • Обнуление .bss                                                   │
    │  • Передача управления в main()                                     │
    └─────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │  4. ФУНКЦИЯ main()                                                  │
    │     Адрес: 0x100002D0                                               │
    ├─────────────────────────────────────────────────────────────────────┤
    │  • Инициализация модулей (stdio, GPIO, ...)                         │
    │  • Суперцикл — бесконечный цикл работы приложения                   │
    └─────────────────────────────────────────────────────────────────────┘
```

| **[[ВПО как исходный код\|Предыдущий раздел]]** | [[Как начать писать код для микроконтроллера\|К занятию]] | **[[Память в ВПО\|Следующий раздел]]** |
| ----------------------------------------------- | --------------------------------------------------------- | -------------------------------------- |
