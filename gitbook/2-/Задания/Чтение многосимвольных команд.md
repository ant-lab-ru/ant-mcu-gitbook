---
тема: Управляемый светодиод
автор: Егор Анатольевич Денисов
дата: 2026-02-11
---

# Результат

- [ ] создан проект `02-control`;
- [ ] создана папка с файлами `sdtio-task.h` и `stdio-task.c`;
- [ ] `stdio-task.c` добавлен в `CMakeLists.txt`;
- [ ] в `stdio-task` созданы функции инициализации и обработчика;
- [ ] в `stdio-task.c` написана логика чтения многосимвольных команд из stdio;
- [ ] в `main.c` добавлена инициализация и регулярный вызов обработчика `stdio-task`;
- [ ] прошивка скомпилирована и загружена на Pi pico;
- [ ] на каждый отправленный символ в COM-порт этот же символ приходит в ответ;
- [ ] после нажатия `Enter` приходит ответ `received string:` с отображением всей введенной строки:

До нажатия `Enter`:

![[Pasted image 20260211193235.png]]

После нажатия `Enter`:

![[Pasted image 20260211193250.png]]

# Инструкция

1. Создать новый проект c названием `02-control`

> [!ATTENTION] Внимание!
> Не забудьте поменять название проекта в `CMakeLists.txt`

2. создать в проекте папку `stdio-task` для добавления модуля чтения из многострочных команд из терминала. В папке создать файлы `stdio-task.h` и `stdio-task.c`. Должна получиться следующая структура файлов:

```
02-control
|-- stdio-task
|   |-- stdio-task.h
|   `-- stdio-task.c
|-- main.c
|-- CMakeLists.txt
|-- memmap_rp2040.ld
|-- pico_sdk_import.cmake
```

3. в `CMakeLists.txt` добавить в add_executable включение исходных файлов `stdio_task`:

``` cmake
${CMAKE_CURRENT_SOURCE_DIR}/stdio-task/stdio-task.c
```

4. в файл `stdio-task.h` добавить директиву препроцессора для предотвращения многократного включения заголовочного файла:

```
#pragma once
```

5. добавить прототипы функций модуля `stdio-task`:

``` c
void stdio_task_init();
char* stdio_task_handle();
```

6. в файл `stdio-task.c` добавить заголовочные файлы:

``` c
#include "stdio-task.h"
#include "stdio.h"
#include "pico/stdlib.h"
```

7. создать буфер приема символов и счетчик длины буфера:

``` c
#define COMMAND_BUF_LEN 128

char command[COMMAND_BUF_LEN] = {0};

int command_buf_idx;
```

8. создать функцию инициализации

``` c
void stdio_task_init()
{
	command_buf_idx = 0;
}
```

9. создать функцию обработчика

``` c
char* stdio_task_handle()
{
	int symbol = getchar_timeout_us(0);
	if (symbol == PICO_ERROR_TIMEOUT)
	{
		return NULL;
	}

	putchar(symbol);

	if (symbol == '\r' || symbol == '\n')
	{
		command[command_buf_idx] = '\0';
		command_buf_idx = 0;
		
		printf("received string: '%s'\n", command);

	return command;
	}

	if (command_buf_idx >= COMMAND_BUF_LEN - 1)
	{
		command_buf_idx = 0;
		return NULL;
	}

	command[command_buf_idx] = symbol;
	command_buf_idx++;
	return NULL;
}
```

10. в `main.c` добавить включение заголовочного файла модуля `stdio-task`:

``` c
#include "stdio-task/stdio-task.h"
```

11. перед бесконечным циклом один раз вызвать функцию инициализации `stdio_task`
12. в бесконечном цикле вызывать функцию обработчика `stdio_task`. Задержек в бесконечном цикле быть не должно!
13. скомпилировать прошивку, загрузить в RP2040, проверить работоспособность. На каждый отправленный символ в COM-порт, RP2040 должен возвращать этот символ назад. После нажатия `Etner` должен прийти ответ `received string:` с отображением всей введенной строки.